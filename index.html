<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"></meta>
  <title>Dynamic Sheets Data</title>

  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css"
    href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Center the loading spinner */
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      /* Hidden by default */
      z-index: 9999;
    }
  </style>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .large-header {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      min-width: 142px; /* Ensures minimum width */
      display: inline-block; /* Allows min-width to work */
    }
    
    .edit-input {
  width: 100%;
  padding: 8px;
  font-size: 14px;
  border-radius: 5px;
  transition: all 0.3s ease-in-out;
}

.edit-input.custom-date-input {
  width: 140px; /* Adjust width as needed */
  border: 0.5px solid #007bff;
  background-color: #ffffff;
  color: #333;
}
.edit-input.custom-drop {
  width: 150px; 
}

.edit-input.custom-date-input:focus {
  border-color: #0056b3;
  background-color: #f8f9fa;
  outline: none;
}

    .header {
      background: #2c3e50;
      padding: 20px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    h1 {
      color: #ffffff;
      font-weight: 500;
      margin: 0;
      text-align: center;
      font-size: 2.2em;
    }

    #dataTable {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      padding: 20px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .filter-container {
      background: #ffffff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    /* Enhanced button styles */
    .add-btn {
      background: linear-gradient(to right, #1976d2, #1565c0);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
    }

    .add-btn:hover {
      background: linear-gradient(to right, #1565c0, #0d47a1);
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.4);
      transform: translateY(-1px);
    }

    /* Update the header styles */
    #dataTable thead th {
      background: #2c3e50;
      color: white;
      font-weight: 500;
      padding: 12px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #dataTable thead th:hover {
      background: #34495e;
    }

    /* Remove all sorting icons */
    table.dataTable thead .sorting,
    table.dataTable thead .sorting_asc,
    table.dataTable thead .sorting_desc,
    table.dataTable thead .sorting_asc_disabled,
    table.dataTable thead .sorting_desc_disabled {
      padding-right: 12px !important;
    }

    #dataTable tbody td {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    #dataTable tbody tr:hover {
      background-color: #f8f9fa;
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter {
      margin-bottom: 20px;
    }

    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .dataTables_wrapper .fs_filter input[type="search"] {
      width: 250px;
      margin-bottom: 20px;
    }

    .paginate_button .current {
      color: white;
    }

    .dataTables_info {
      margin-top: 20px;
      color: #666;
    }

    .dataTables_paginate .paginate_button {
      padding: 8px 14px;
      margin: 0 4px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }


    .dataTables_paginate .paginate_button.current {
      background: #2c3e50 !important;
      color: white !important;
      border: 1px solid #2c3e50 !important;
    }

    .dataTables_paginate .paginate_button:hover {
      background: #34495e !important;
      color: white !important;
      border: 1px solid #34495e !important;
    }

    .filter-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .filter-group {
      display: flex;
      align-items: center;
    }

    #sheetSelector,
    .drop-down {
      background-color: white;
      min-width: 200px;
      margin-right: 20px;
    }

    .dataTables_filter {
      margin-bottom: 0 !important;
    }

    .dataTables_wrapper .dataTables_filter input {
      margin-left: 10px;
    }

    #sheetSelector:focus {
      outline: none;
      border-color: #2c3e50;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .edit-btn,
    .delete-btn,
    .save-btn,
    .cancel-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .edit-btn {
      background-color: #2196F3;
      color: white;
    }

    .delete-btn {
      background-color: #f44336;
      color: white;
    }

    .save-btn {
      background-color: #4CAF50;
      color: white;
    }

    .cancel-btn {
      background-color: #607D8B;
      color: white;
    }

    .editing {
      background-color: rgba(33, 150, 243, 0.1);
    }

    .cell-editor {
      width: 100%;
      padding: 6px;
      border: 1px solid #2196F3;
      border-radius: 4px;
    }

    /* Responsive styles */
    @media screen and (max-width: 1024px) {
      .container {
        padding: 10px;
        max-width: 100%;
      }
    }

    @media screen and (max-width: 768px) {
      .filter-container {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
      }

      .filter-group,
      #searchContainer {
        width: 100%;
      }

      .dataTables_filter {
        width: 100%;
        margin: 0;
      }

      .dataTables_filter input {
        width: 100% !important;
        margin-left: 0 !important;
      }

      #sheetSelector {
        width: 100%;
        margin-right: 0;
      }

      .action-buttons {
        flex-direction: column;
        gap: 5px;
      }

      .edit-btn,
      .delete-btn,
      .save-btn,
      .cancel-btn {
        width: 100%;
      }

      /* Make table scrollable horizontally */
      .dataTables_wrapper {
        overflow-x: auto;
      }

      #dataTable {
        min-width: 800px;
        /* Minimum width to prevent squishing */
      }

      /* Adjust header text */
      h1 {
        font-size: 1.8em;
        padding: 0 15px;
      }
    }

    @media screen and (max-width: 480px) {
      h1 {
        font-size: 1.5em;
      }

      .header {
        padding: 15px 0;
      }

      /* Adjust cell padding for better mobile view */
      #dataTable tbody td {
        padding: 8px;
      }

      /* Make inputs more touch-friendly */
      .cell-editor {
        padding: 8px;
        font-size: 16px;
        /* Better for mobile input */
      }

      .edit-btn,
      .delete-btn,
      .save-btn,
      .cancel-btn {
        padding: 8px;
        font-size: 14px;
      }
    }

    .date-input {
      width: 100px !important;
      text-align: center;
    }

    .add-button-container {
      text-align: right;
    }

    .add-btn {
      background-color: #4CAF50;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .add-btn:hover {
      background-color: #45a049;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow-y: auto;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 50px auto;
      padding: 30px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      position: relative;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .modal h2 {
      color: #2c3e50;
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
    }

    .close {
      position: absolute;
      right: 25px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #666;
      transition: color 0.3s;
    }

    .close:hover {
      color: #000;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #2c3e50;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
    }

    .form-buttons {
      text-align: right;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .form-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .submit-btn {
      background-color: #4CAF50;
      color: white;
      margin-left: 10px;
    }

    .submit-btn:hover {
      background-color: #45a049;
    }

    .cancel-btn {
      background-color: #f5f5f5;
      color: #333;
    }

    .cancel-btn:hover {
      background-color: #e0e0e0;
    }

    /* Add New Entry button styles */
    .add-button-container {
      text-align: right;
      margin-bottom: 20px;
    }

    .add-btn {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .add-btn:hover {
      background-color: #45a049;
    }

    /* Responsive styles for the form */
    @media screen and (max-width: 768px) {
      .modal-content {
        margin: 20px auto;
        padding: 20px;
        width: 95%;
      }

      .form-buttons button {
        width: calc(50% - 5px);
        margin: 0;
      }

      .form-buttons button:first-child {
        margin-right: 10px;
      }
    }

    @media screen and (max-width: 480px) {
      .modal-content {
        margin: 10px auto;
        padding: 15px;
      }

      .form-group label {
        font-size: 14px;
      }

      .form-group input,
      .form-group select {
        padding: 8px;
        font-size: 16px;
        /* Better for mobile input */
      }

      .form-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .form-buttons button {
        width: 100%;
        padding: 12px;
      }
    }

    .wait-message {
      color: #ff0000;
      font-weight: bold;
      margin-right: 10px;
      display: none;
    }

    .form-buttons {
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    /* Enhanced button styles */
    .add-btn {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      transition: all 0.3s ease;
    }

    .add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      background: linear-gradient(135deg, #45a049, #4CAF50);
    }

    /* Add these styles to remove default DataTables sorting icons */
    table.dataTable thead .sorting:before,
    table.dataTable thead .sorting:after,
    table.dataTable thead .sorting_asc:before,
    table.dataTable thead .sorting_asc:after,
    table.dataTable thead .sorting_desc:before,
    table.dataTable thead .sorting_desc:after,
    table.dataTable thead .sorting_asc_disabled:before,
    table.dataTable thead .sorting_asc_disabled:after,
    table.dataTable thead .sorting_desc_disabled:before,
    table.dataTable thead .sorting_desc_disabled:after {
      display: none !important;
    }

    .pdf-btn {
      background-color: #FF5722;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
      transition: background-color 0.3s;
      width: 36px;
      /* Make it square */
      height: 36px;
      /* Make it square */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pdf-btn:hover {
      background-color: #F4511E;
    }

    .pdf-btn i {
      font-size: 16px;
    }


    /* General styling for input fields */


  </style>
</head>

<body>
  <!-- Navbar -->
  <div class="header">
    <h1>BRIGHTER DAYS RECOVERY CENTER</h1>
  </div>

  <!-- Loading Spinner -->
  <div id="loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">

    <div class="filter-container" style="margin-bottom: 20px;">
      <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 20px;">
        <!-- Facility/Discharge Dropdown -->
        <div class="filter-group" style="flex: 1 1 200px;">
          <label for="isDischarge" style="margin-right: 10px; font-weight: 500;">Facility/Discharge:</label>
          <select id="isDischarge" class="drop-down" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
            <option value="1">Facility</option>
            <option value="2">Discharge</option>
          </select>
        </div>
      
        <!-- Facility Dropdown -->
        <div class="filter-group" style="flex: 1 1 200px;">
          <label for="sheetSelector" style="margin-right: 10px; font-weight: 500;">Facility:</label>
          <select id="sheetSelector" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
            <option value="">All Facilities</option>
          </select>
        </div>
      
        <!-- Room Number Filter -->
        <div class="filter-group" style="flex: 1 1 200px; gap: 2px;">
          <label for="roomNumberFilter" class="drop-down" style="margin-right: 10px; font-weight: 500;">Room Number Filter:</label>
          <select id="roomNumberFilter" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; min-width: 150px; max-width: 300px;">
          </select>
        </div>
      
        <!-- Unit Filter -->
        <div class="filter-group" style="flex: 1 1 200px;">
          <label for="unitFilter" class="drop-down" style="margin-right: 10px; font-weight: 500;">Unit Filter:</label>
          <select id="unitFilter" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; width: 50%;">
          </select>
        </div>

        <div class="filter-group" style="flex: 1 1 200px;">
          <label for="colorFilter" class="drop-down" style="margin-right: 10px; font-weight: 500;">Color Filter:</label>
          <select id="colorFilter" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; width: 50%;">
              <option value="">All Color</option>
              <option value="Red">Red</option>
              <option value="Purple">Purple</option>
              <option value="White">White</option>
          </select>
        </div>
      
        <!-- BIMS Filter -->
        <div class="filter-group" style="flex: 1 1 200px;">
          <label for="bimsFilter" class="drop-down" style="margin-right: 10px; font-weight: 500;">BIMS Filter:</label>
          <select id="bimsFilter" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; width: 10%;">
            <option value="">Select</option>
            <option value="null">Null</option>
           
            <option value="0-7">0-7</option>
            <option value="8-15">8-15</option>
            <option value="99">99</option>
            <option value="NC">Not Cognitive</option>
           
          </select>
        </div>
      
        <!-- Alert Button -->
        <div style="flex: 0 0 auto; margin-left: auto;">
          <img src="https://uxwing.com/wp-content/themes/uxwing/download/communication-chat-call/bell-line-icon.png" hidden id="alertButton" style="width: 30px; cursor: pointer;" alt="Alerts">
        </div>
  </div>
</div>

  

      
      <!-- Add New Entry Button -->
      <div class="add-button-container" style="margin-bottom: 20px; text-align: right;">
        <button id="addNewBtn" class="add-btn" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Add New Entry</button>
        <button id="addNewSheetBtn" class="add-btn" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Add New Sheet</button>
      </div>
      
      <!-- Add Sheet Modal -->
      <div id="addSheetModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2>Add New Sheet</h2>
          <form id="addSheetForm">
            <div class="form-group">
              <label for="newSheetName">Sheet Name:</label>
              <input type="text" id="newSheetName" required>
            </div>
            <div class="form-buttons">
              <span class="wait-message">Please wait...</span>
              <button type="submit" class="submit-btn">Submit</button>
              <button type="button" class="cancel-btn">Cancel</button>
            </div>
          </form>
        </div>
      </div>


    <!-- Responsive Table -->
    <div class="table-responsive" style="margin: 30px; width: calc(100% - 60px);overflow-x: auto;">
      <table id="dataTable" class="display" style="margin-top: 20px;">
        <thead>
          <tr></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>


    

  <div id="addFormModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closePopup()">&times;</span>
      <h2>Add New Entry</h2>
      <form id="addForm">
        <div class="form-group">
          <label for="payer">Payer:</label>
          <input type="text" id="payer" >
        </div>
        <div class="form-group">
          <label for="expiry">Prior Auth Expiry Date:</label>
          <input type="date" id="expiry" >
        </div>
        <div class="form-group">
          <label for="unit">Unit:</label>
          <input type="text" id="unit" required>
        </div>
        <div class="form-group">
          <label for="roomNumber">Room Number:</label>
          <input type="text" id="roomNumber" required>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
          <label>
              <input type="radio" name="color" value="#ff0000"> Red
          </label>
      
          <label>
              <input type="radio" name="color" value="#d9d2e9"> Purple
          </label>
      
          <label>
              <input type="radio" name="color" value="white" checked> White 
          </label>
      </div>
      
      <br>
        <div class="form-group">
          <label for="residentFullName">Resident Full Name:</label>
          <input type="text" id="residentFullName" required>
        </div>
        <div class="form-group">
          <label for="bimsScore">BIMS score:</label>
          <select id="bimsScore" >
            <option value=" ">Select</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="99">99</option>
            <option value="Not Cognitive">Not Cognitive</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="biopsychosocialAssessment">Biopsychosocial Assessment:</label>
          <select id="biopsychosocialAssessment">
            <option value=" ">Select</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>
        <div class="form-group">
          <label for="suddx">SUD DX</label>
          <input type="text"  id="suddx">
        </div>
        <div class="form-group">
          <label for="eligibleForSUD">Eligible for SUD:</label>
          <select id="eligibleForSUD" >
            <option value=" ">Select</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>

        <div class="form-group">
          <label for="LastVisitType">Last visit Type:</label>
          <select id="LastVisitType" >
            <option value=" ">Select</option>
            <option value="Biopsych Assessment">Biopsych Assessment</option>
            <option value="CBT/ Psychotherapy">CBT/ Psychotherapy</option>
            <option value="Full Cognitive Exam">Full Cognitive Exam</option>
            <option value="Initial Med Visit">Initial Med Visit</option>
            <option value="Followup Med Visit">Followup Med Visit</option>
            <option value="Consult">Consult</option>
            <option value="Pain Management">Pain Management</option>
            <option value="SUD/Biopsychosocial assessment">SUD/Biopsychosocial assessment</option>
            <option value="SUD/Med Visit">SUD/Med Visit</option>
            <option value="SUD Intake">SUD Intake</option>
            <option value="SUD/CBT">SUD/CBT</option>
            <option value="SUD Follow-up">SUD Follow-up</option>
            <option value="SUD Consult">SUD Consult</option>
            <option value="Initial Psych">Initial Psych</option>
            <option value="IOP Group Therapy">IOP Group Therapy</option>
            <option value="IOP CBT">IOP CBT</option>
            <option value="PHP Group Therapy">PHP Group Therapy</option>
            <option value="PHP CBT">PHP CBT</option>
          </select>
        </div>
      
        <div class="form-group">
          <label for="lastVisitDate">Last Visit Date:</label>
          <input type="date" id="lastVisitDate" >
        </div>
        <div class="form-group">
          <label for="programs">Programs:</label>
          <select id="programs" required>
            <option value="Select">Select</option>
            <option value="PRP-Completed">PRP-Completed</option>
            <option value="IOP-Completed">IOP-Completed</option>
            <option value="PHP-Completed">PHP-Completed</option>
            <option value="PRP-Approved">PRP-Approved</option>
            <option value="IOP-Approved">IOP-Approved</option>
            <option value="PHP-Approved">PHP-Approved</option>
          </select>
        </div>
        <div class="form-buttons">
          <span class="wait-message">Please wait...</span>
          <button type="submit" class="submit-btn">Submit</button>
          <!-- <button type="button" class="cancel-btn" onclick='closeme()'>Cancel</button> -->
          <button type="button" class="cancel-btn" onclick='closePopup()'>Cancel</button>
        </div>
      </form>
    </div>
  </div>



  <div id="sheetFormModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closenewsheet()" >&times;</span>
      <h2>Add New Entry</h2>
      <form id="sheetForm">
  
        <div class="form-group">
          <label for="newsheet">Sheet Name</label>
          <input type="text" id="newsheet" required value="Default Value">
        </div>

        <div class="form-buttons">
          <span class="wait-message">Please wait...</span>
          <button type="submit" class="submit-btn">Submit</button>
          <button type="button" class="cancel-btn" onclick='closenewsheet()'>Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="alertTables" class="modal">
    <div class="modal-content">
      <span class="close" id="alertTableClose">&times;</span>
      <h2>Alerts</h2>
      <table id="alertTable" class="display" style="margin-top: 20px;">
        <thead>
          <tr></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>


  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
  <style>
    input[type="search"] {
      background-color: rgb(232, 230, 227) !important;
      width: 300px !important;
      height: 30px !important;
      border-radius: 10px !important;
      border: 1px solid #ddd !important;
      padding-left: 10px !important;
    }

    #sheetSelector {
      background-color: rgb(232, 230, 227) !important;
      padding: 6px 10px !important;
      border: 1px solid #ddd !important;
      border-radius: 4px !important;
      min-width: 200px !important;
    }
  </style>
  <script>


    $(document).ready(function () {
     
   const apiUrl ="http://localhost:7002";

  
      const $sheetSelector = $('#sheetSelector');
      const $dataTable = $('#dataTable');
      const $loading = $('#loading');
      const $alertButton = $('#alertButton');
      const $alertTable = $('#alertTables');
      const $roomNumberFilter = $('#roomNumberFilter');
      const $unitFilter = $('#unitFilter')
      const $bimsFilter = $('#bimsFilter')
      const $isDischarge = $("#isDischarge");
      const $colorFilter = $('#colorFilter');
      let dataTableInstance;
      let sheetsData = [];

      let reloadtimeinterval = false;
    
      function closePopup() {
            modal.style.display = "none"
        }
      window.closePopup=closePopup;

        function closenewsheet(){
          modelsheet.style.display = "none"
        }
      window.closenewsheet=closenewsheet;
      $isDischarge.change(function (e) {
        const isDischargeMode = e.target.value == 1; 

        $sheetSelector.empty(); // Clear the dropdown

        // Filter and populate the dropdown based on the mode
        sheetsData.forEach(sheet => {
          const isDischargeSheet = sheet.sheet_name.toLowerCase().includes("discharge_");
          const isSelected = localStorage.getItem("selectedSheet") === sheet.sheet_name;

          // Append options based on the mode
          if ((isDischargeMode && !isDischargeSheet) || (!isDischargeMode && isDischargeSheet)) {
            const option = `<option value="${sheet.sheet_name}" ${isSelected ? "selected" : ""}>${sheet.sheet_name}</option>`;
            $sheetSelector.append(option);
          }
        });

        // Trigger the change event to load data for the selected sheet
        $sheetSelector.trigger("change");
      });
      // Show/hide loading spinner
      function showLoading() { $loading.show(); }
      function hideLoading() { $loading.hide(); }
      function checkForAlert(sheet_data) {
        for (let i = 0; i < sheet_data.length; i++) {
          if (sheet_data[i]['Prior Auth Expiry Date']) {
            const [month, day, year] = sheet_data[i]['Prior Auth Expiry Date'].split("/").map(Number);
            //console.log(month, day, year);
           // console.log(sheet_data[i]['Prior Auth Expiry Date']);
            const expiryDate = new Date(year, month - 1, day);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            expiryDate.setHours(0, 0, 0, 0);
            const timeDifference = expiryDate - today;
            const daysDifference = timeDifference / (1000 * 60 * 60 * 24);
            if (daysDifference <= 20) {

              $alertButton.on('click', function () {
                $('#alertTableClose').on('click', function () {
                  $alertTable.hide();
                });
               // console.log('Alert Button Clicked');
                $alertTable.show();
                const alertTable = $('#alertTable').DataTable({
                  responsive: false,
                  screenX: true,
                  destroy: true,
                  data: sheet_data
                    .filter(row => {
                      if (row['Prior Auth Expiry Date']) {
                        const [month, day, year] = row['Prior Auth Expiry Date'].split("/").map(Number);
                        const expiryDate = new Date(year, month - 1, day);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        expiryDate.setHours(0, 0, 0, 0);
                        const timeDifference = expiryDate - today;
                        const daysDifference = timeDifference / (1000 * 60 * 60 * 24);
                        return daysDifference <= 20;
                      }
                    })
                    .map(row => ({
                      PAYER: row['PAYER'],
                      'Prior Auth Expiry Date': row['Prior Auth Expiry Date'],
                      'Resident Full Name': row['Resident Full Name']
                    })), // Ensure only these columns exist in the dataset
                  columns: [
                    { data: 'PAYER', title: 'PAYER' },
                    { data: 'Prior Auth Expiry Date', title: 'Prior Auth Expiry Date' },
                    { data: 'Resident Full Name', title: 'Resident Full Name' }
                  ],
                  paging: true,
                  searching: true,
                  ordering: true,
                  dom: '<"top"f>rt<"bottom"ip>',
                });


              });

              return true;
            }
          }
        }
        return false;
      }

    
      showLoading();


      $.getJSON(apiUrl+"/get-sheets", function (data) {
        hideLoading();
       console.log(data);
        if (data && data.length > 0) {
          sheetsData = data;
          const savedSheet = localStorage.getItem('selectedSheet');
          populateSheetDropdown(data, savedSheet);
          const selectedSheet = sheetsData.find(sheet => sheet.sheet_name === savedSheet) || data[0];
          loadSheetData(selectedSheet);
        } else {
          alert("No data found!");
        }
      }).fail(function (e) {
        hideLoading();
        console.log(e);
        alert("Failed to fetch data from the API.");
      });
  

      function fetchData() {
     
          $.getJSON(apiUrl+"/get-sheets", function (data) {
            console.log(data);
            if (data && data.length > 0) {
              sheetsData = data;
              const savedSheet = localStorage.getItem('selectedSheet');
              populateSheetDropdown(data, savedSheet);
              const selectedSheet = sheetsData.find(sheet => sheet.sheet_name === savedSheet) || data[0];
              loadSheetData(selectedSheet);
              reloadtimeinterval = true;
              //console.log(reloadtimeinterval);
            } else {
              reloadtimeinterval = true;
              //console.log(reloadtimeinterval);
             // alert("No data found!");
            }
          }).fail(function (e) {
            
            console.log(e);
            alert("Failed to fetch data from the API.");
          });  
        
      }
      
      function fetchDataConditionally() {
        if (reloadtimeinterval) {
          reloadtimeinterval=false;
          fetchData();
        }
      }
      
      setInterval(fetchDataConditionally,15000);



      function populateSheetDropdown(data, sheet_name) {
        // Clear the dropdown
        $sheetSelector.empty();

        // Determine if we are filtering for "discharge_" sheets
        const isDischargeSheet = sheet_name && sheet_name.toLowerCase().includes("discharge_");

        data.forEach(sheet => {
          const sheetNameLower = sheet.sheet_name.toLowerCase();

          if ((!sheet_name) || (isDischargeSheet && sheetNameLower.includes("discharge_")) || (!isDischargeSheet && !sheetNameLower.includes("discharge_"))) {
         
            const isSelected = localStorage.getItem("selectedSheet") === sheet.sheet_name;
       
            $sheetSelector.append(`<option value="${sheet.sheet_name}" ${isSelected ? "selected" : ""}>${sheet.sheet_name}</option>`);
          }
        });
      }


      function loadSheetData(sheet) {
        if (!sheet || !sheet.sheet_data || sheet.sheet_data.length === 0) return;
        console.log(sheet.sheet_name);
      
        if (sheet.sheet_name.toLowerCase().includes("discharge_")) {
          $isDischarge.val('2');
          $sheetSelector.val(sheet.sheet_name);
        } else {
          $isDischarge.val('1');
          $sheetSelector.val(sheet.sheet_name);
        }
      
        if (checkForAlert(sheet.sheet_data)) {
          $alertButton.show();
        } else {
          $alertButton.hide();
        }
      
        let columnArray = ['PAYER', 'Prior Auth Expiry Date', 'Unit', 'Room Number', 'Resident Full Name', 'BIMS score', 'Biopsychosocial Assessment', 'SUD DX', 'Eligible for CBT', 'Eligible for SUD', 'Eligible for SUD CBT', 'Last Visit Date', 'Last Visit Type', 'Programs'];
      
        let filteredData = sheet.sheet_data
          .map(row => {
            let completeRow = {};
            let hasData = false; // Flag to check if at least one column has a value
      
            columnArray.forEach(col => {
              let value = row[col] !== undefined && row[col] !== null ? String(row[col]).trim() : ""; // Ensure value is a string and trim it
              completeRow[col] = value;
              if (value !== "") hasData = true; // If any column has a value, mark as non-empty
            });
            
            completeRow['Resident Full Name Background'] = row['Resident Full Name Background'];
            completeRow['id'] = row['id'];
            if(completeRow['SUD DX']=="NA"){
              completeRow['Eligible for SUD']="Yes";
            }

            if(completeRow['Eligible for SUD']=="Yes" && completeRow['Eligible for CBT']=="Yes" ){
              completeRow['Eligible for SUD CBT']="Yes";
            }

            return hasData ? completeRow : null; // Keep row if it has data, otherwise return null
          })
          .filter(row => row !== null); 
      
       



      
        const uniqueRoomNumbers = new Set();
        const uniqueUnits = new Set();
   
  
        // Populate the Sets with unique values from the filtered data
        filteredData.forEach(row => {
          if (row['Room Number']) uniqueRoomNumbers.add(row['Room Number']);
          if (row['Unit']) uniqueUnits.add(row['Unit']);
        });
      
        $roomNumberFilter.empty();
        $unitFilter.empty();
   
   

        $roomNumberFilter.append(`<option value="">All</option>`);
        $unitFilter.append(`<option value="">All</option>`);
      
        
      

      
        uniqueRoomNumbers.forEach(roomNumber => {
          $roomNumberFilter.append(`<option value="${roomNumber}">${roomNumber}</option>`);
        });
      
        uniqueUnits.forEach(unit => {
          $unitFilter.append(`<option value="${unit}">${unit}</option>`);
        });
      
      
        const storedData = JSON.parse(localStorage.getItem('filteredData'));
        if (storedData) {
          filteredData = storedData; 
        }
      
       
        if ($.fn.dataTable.isDataTable($dataTable)) {
          dataTableInstance.clear().rows.add(filteredData).draw();
        } else {
          dataTableInstance = $dataTable.DataTable({
            responsive: false,
            destroy: true,
            scrollX: true,
            data: filteredData,
            columns: [
              ...columnArray.map(header => ({
                data: header,
                title: `<span class="large-header" script="min width=142">${header.replace(/_/g, ' ')}</span>`
              })),
              {
                title: 'Actions',
                data: null,
                orderable: false,
                render: function (data, type, row) {
                  const rowData = encodeURIComponent(JSON.stringify(row));
                 // console.log(localStorage.getItem("selectedSheet"));
                  return localStorage.getItem("selectedSheet").toLowerCase().includes("discharge")
                    ? `<button class="edit-btn" onclick="reAdmitRow('${rowData}')">Readmit</button>`
                    : `<div class="action-buttons">
                            <button class="edit-btn" onclick="editRow('${rowData}')">Edit</button>
                            <button class="delete-btn" onclick="deleteRow('${rowData}')">Delete</button>
                           </div>`;
                }
              }
            ],
            paging: true,
            searching: true,
            ordering: true,
            dom: '<"top"f>rt<"bottom"ip>',
            language: {
              search: "Patient Lookup : ",
              info: "Showing _TOTAL_ entries",
              paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
              }
            },
            pageLength: 100,
            rowCallback: function (row, data, index) {
              // Check if the background color is available in the row data
              const backgroundColor = data['Resident Full Name Background'];
           
              if (backgroundColor) {
                // Find the "Resident Full Name" cell
                const cell = $(row).find('td').eq(columnArray.indexOf('Resident Full Name'));
                // Set the background color from the "Resident Full Name Background" field
                cell.css('background-color', backgroundColor);
              }
            }
          });
        }
      }

      $colorFilter.on('change', function() {
        // Define the columns and color mapping
        const columnArray = ['PAYER', 'Prior Auth Expiry Date', 'Unit', 'Room Number', 'Resident Full Name', 'BIMS score', 'Biopsychosocial Assessment', 'SUD DX', 'Eligible for CBT', 'Eligible for SUD', 'Eligible for SUD CBT', 'Last Visit Date', 'Last Visit Type', 'Programs'];
        const colorMapping = { "": "", Red: '#ff0000', Purple: '#d9d2e9', White: '#ffffff' };
    
        const selectedColor = $(this).val(); // Get the selected color from the dropdown
        const searchTerm = colorMapping[selectedColor] || selectedColor; // Map color name to hex code, or use as-is
    
        dataTableInstance.rows().every(function() {
            const rowData = this.data();
            const bgColor = rowData['Resident Full Name Background'];
    
     
    
            // If the background color matches or if "All Color" is selected
            if (bgColor && (searchTerm === "" || bgColor === searchTerm)) {
                // Show the row and apply background color
                $(this.node()).show();
                $(this.node()).find('td').eq(columnArray.indexOf('Resident Full Name')).css('background-color', bgColor);
            } else {
                // Hide the row if it doesn't match the selected filter
                $(this.node()).hide();
            }
        });
    
        // Redraw the table after the filtering process
        dataTableInstance.draw();
    });
    
    
    
    
    
      $roomNumberFilter.change(function (e) {
        const selectedRoomNumber = e.target.value;
        dataTableInstance.columns(3).search(selectedRoomNumber).draw();
      });
      
      $unitFilter.change(function (e) {
        const selectedUnit = e.target.value;
        dataTableInstance.columns(2).search(selectedUnit).draw();
      });
      
      


      $bimsFilter.change(function (e) {
        const selectedBims = e.target.value;
        const bimsMapping = {
      
          "0-7": "^0$|^1$|^2$|^3$|^4$|^5$|^6$|^7$",
          "8-15": "8|9|10|11|12|13|14|15", // Regex to match values 8 to 15
          "99": "99", // Exact match for 99
          "NC": "Not Cognitive", // Exact match for NC
          "null": "" // Empty string for "All" (no filter)
        };

       
      
        const searchTerm = bimsMapping[selectedBims] || "";

        console.log(searchTerm);
      
        dataTableInstance.columns(5).search('^' + searchTerm + '$', true, false).draw();

      });
      


      const modal = document.getElementById('addFormModal');
      const addBtn = document.getElementById('addNewBtn');
      const addsheet=document.getElementById('addNewSheetBtn')
      const closeBtn = document.getElementsByClassName('close')[0];
      const addForm = document.getElementById('addForm');
      const sheetForm=document.getElementById('sheetForm');
      const modelsheet=document.getElementById('sheetFormModal');//adding sheets
      
  

      addsheet.onclick=function(){
        modelsheet.style.display="Block";
      }

      addBtn.onclick = function () {
        modal.style.display = "block";
      }
      
     
      window.onclick = function (event) {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      }



    //   document.querySelector('.close').onclick = () => {
    //   document.getElementById('sheetFormModal').style.display = 'none';
    // };

    // // Cancel Button
    // document.querySelector('.cancel-btn').onclick = () => {
    //   document.getElementById('sheetFormModal').style.display = 'none';
    //   document.getElementById('sheetForm').reset();
    // };

 
    // // AJAX Form Submission
     document.getElementById('sheetForm').onsubmit = function (e) {
      e.preventDefault();
      reloadtimeinterval = false;
      const waitMessage = document.querySelector('.wait-message');
      const submitBtn = document.querySelector('.submit-btn');
      waitMessage.style.display = 'inline';
      submitBtn.disabled = true;
      submitBtn.style.opacity = '0.7';

      let data = {
        "sheetName": document.getElementById('newsheet').value
      };

      $.ajax({
        url: "http://localhost:7002/addSheet",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ data }),
        success: function (response) {
          console.log(response);
          waitMessage.style.display = 'none';
          submitBtn.disabled = false;
          submitBtn.style.opacity = '1';

          if (response.success) {
            alert('Sheet added successfully!');
            document.getElementById('sheetFormModal').style.display = 'none';
            document.getElementById('sheetForm').reset();
            reloadtimeinterval = true;
          } else {
            alert('Failed to add new entry: ' + response.message);
            reloadtimeinterval = true;
          }
        },
        error: function () {
          alert('Failed to connect to the server. Please try again.');
          waitMessage.style.display = 'none';
          submitBtn.disabled = false;
          submitBtn.style.opacity = '1';
          reloadtimeinterval = true;
       }
      });
    };


//     document.getElementById('sheetForm').onsubmit = function (e) {
//   e.preventDefault();

//   const waitMessage = document.querySelector('.wait-message');
//   const submitBtn = document.querySelector('.submit-btn');
//   waitMessage.style.display = 'inline';
//   submitBtn.disabled = true;
//   submitBtn.style.opacity = '0.7';

//   const sheetName = document.getElementById('newsheet').value.trim(); // Get the value from the input field

//   if (!sheetName) {
//     alert("Please enter a sheet name.");
//     waitMessage.style.display = 'none';
//     submitBtn.disabled = false;
//     submitBtn.style.opacity = '1';
//     return;
//   }

//   const scriptURL = "https://script.google.com/macros/s/AKfycbwdbNMo1YqIS0T4QJgNgSVXvZaPZX6D1vbm9FZY1S_xYZDyCHTmyeO3pHd6hIcdSRfN/exec";

//   fetch(scriptURL, {
//     method: "POST",
//     mode: "cors",
//     headers: { "Content-Type": "application/json" },
//     body: JSON.stringify({ action: "createSheet", sheet_name: sheetName }), // Use the sheetName variable here!
//   })
//     .then(response => {
//       if (!response.ok) { // Check for HTTP errors
//         return response.json().then(err => {throw new Error(err.message || response.statusText)}); // Throw error with message
//       }
//       return response.json();
//     })
//     .then(data => {
//       console.log(data.message); // Or display the message in the UI
//       alert(data.message); // Show a success message to the user
//       document.getElementById('newsheet').value = ''; // Clear the input field
//     })
//     .catch(error => {
//       console.error("Error:", error);
//       alert("Error creating sheet: " + error.message); // Show the error to the user
//     })
//     .finally(() => { // Always re-enable the button
//       waitMessage.style.display = 'none';
//       submitBtn.disabled = false;
//       submitBtn.style.opacity = '1';
//     });
// };


      addForm.onsubmit = function (e) {
        e.preventDefault();
        reloadtimeinterval = false;
        //console.log(reloadtimeinterval);

        // Show wait message and disable submit button
        const waitMessage = document.querySelector('.wait-message');
        const submitBtn = document.querySelector('.submit-btn');
        waitMessage.style.display = 'inline';
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.7';
       
      //  console.log(document.getElementById('bimsScore').value);
       // console.log(typeof document.getElementById('bimsScore').value);
        let eligible;
        if ((document.getElementById('bimsScore').value >= 0 && document.getElementById('bimsScore').value <= 7) || document.getElementById('bimsScore').value === '99' || document.getElementById('bimsScore').value === "Not Cognitive") {
          eligible = "No";
        } else if (document.getElementById('bimsScore').value >= 8 && document.getElementById('bimsScore').value <= 15) {

          eligible = "Yes";
        } else {
          eligible = "Invalid input";
        }
      let suddx;
        let eligibleForSUDCBT;
        if (document.getElementById('suddx').value === '' ) {
          eligibleForSUDCBT = "Yes";
          suddx = "NA";
        } else {
          eligibleForSUDCBT = "No";
        }
        const newData = {
          'PAYER': document.getElementById('payer').value,
          'Prior Auth Expiry Date': document.getElementById('expiry').value.split("-").reverse().join("/"),
          'Unit': document.getElementById('unit').value,
          'Room Number': document.getElementById('roomNumber').value,
          'Resident Full Name': document.getElementById('residentFullName').value,
          'BIMS score': document.getElementById('bimsScore').value,
          'Eligible for CBT': eligible,
          'Biopsychosocial Assessment': document.getElementById('biopsychosocialAssessment').value,
          'Eligible for SUD': document.getElementById('eligibleForSUD').value,
          'SUD DX': suddx,
          'Eligible for SUD CBT': eligibleForSUDCBT,
          'Programs': document.getElementById('programs').value,
          'Last Visit Type': document.getElementById('LastVisitType').value,
          'Last Visit Date': document.getElementById('lastVisitDate').value.split("-").reverse().join("/"),
          'Resident Full Name Background': document.querySelector('input[name="color"]:checked')?.value
        };

      //  console.log(newData);
       // console.log(newData.Color);

      // $.getJSON(apiUrl + "?action=add" +
      //     "&sheet_name=" + encodeURIComponent($('#sheetSelector').val()) +
      //     "&data=" + encodeURIComponent(JSON.stringify(newData)) +
      //     "&callback=?")
      //     .done( async function (response) {
      //       console.log(response)
      //       if (response.success) {
          
      //         modal.style.display = "none";  
      //         addForm.reset();  
         
           
      //         reloadtimeinterval = true;
         
      //       } else {
      //         alert('Failed to add new entry: ' + response.message);
      //         // Reset wait message and submit button on failure
      //         waitMessage.style.display = 'none';  // Ensure 'waitMessage' is defined
      //         submitBtn.disabled = false;  // Ensure 'submitBtn' is defined
      //         submitBtn.style.opacity = '1';
      //         reloadtimeinterval = true;
      //       }
      //     })
      //     .fail(function () {
      //       alert('Failed to connect to the server. Please try again.');
      //       // Reset wait message and submit button on failure
      //       waitMessage.style.display = 'none';  // Ensure 'waitMessage' is defined
      //       submitBtn.disabled = false;  // Ensure 'submitBtn' is defined
      //       submitBtn.style.opacity = '1';
      //       reloadtimeinterval = true;
      //     });
      // }
      // document.querySelector('.cancel-btn').onclick = function () {
      //   modal.style.display = "none";
      //   addForm.reset(); // Reset form when cancelled
      // } 


      $.ajax({
        url: "http://localhost:7002/addData",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
          sheet_name: $('#sheetSelector').val(),
          data: newData
        }),
        success: async function (response) {
          console.log(response);
          if (response.success) {
            modal.style.display = "none";
            addForm.reset();
            await fetchData();
            reloadtimeinterval = true;
          } else {
            alert('Failed to add new entry: ' + response.message);
            waitMessage.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
            reloadtimeinterval = true;
          }
        },
        error: function () {
          alert('Failed to connect to the server. Please try again.');
          waitMessage.style.display = 'none';
          submitBtn.disabled = false;
          submitBtn.style.opacity = '1';
          reloadtimeinterval = true;
        }
      });
    
      document.querySelector('.cancel-btn').onclick = function () {
        modal.style.display = "none";
        addForm.reset();
      };
      
    }



      // Handle sheet selection
      $sheetSelector.change(function () {
        const selectedSheet = sheetsData.find(sheet => sheet.sheet_name === $(this).val());
        localStorage.setItem('selectedSheet', $(this).val());
        if (selectedSheet) loadSheetData(selectedSheet);
      });

      window.reAdmitRow = function (rowData) {
        const row = JSON.parse(decodeURIComponent(rowData));
        reloadtimeinterval = false;
        //console.log(reloadtimeinterval);
        console.log("Readmitting Row:", row);
        let rowIndex = dataTableInstance.rows().indexes().filter(index => {
          return dataTableInstance.row(index).data()['Resident Full Name'] === row['Resident Full Name'];
        })[0];


        $.ajax({
  url: apiUrl + "/readmitData",
  type: "POST",
  contentType: "application/json",
  data: JSON.stringify({
    sheet_name: $('#sheetSelector').val(),
    rowData: row
  }),
  success: async function(response) {
    console.log(response);
    if (response.success) {
      alert("Readmitted successfully!");
      dataTableInstance.row(rowIndex).remove().draw(false);
      await fetchData();
      reloadtimeinterval = true;
    } else {
      reloadtimeinterval = true;
      alert("Failed to Readmit: " + response.message);
    }
  },
  error: function(xhr, status, error) {
    reloadtimeinterval = true;
    alert(`Error: ${error}`);
  }
});

      }


      
      window.editRow = function (rowData) {
        const row = JSON.parse(decodeURIComponent(rowData));
        reloadtimeinterval = false;
        //console.log(reloadtimeinterval);
        console.log("Editing Row:", row);
        let id ;
        // Find the row in DataTables
        let rowIndex = dataTableInstance.rows().indexes().filter(index => {
           id = row['id'];
          return dataTableInstance.row(index).data()['id'] === row['id'];
        })[0];

        if (rowIndex === undefined) {
          console.error("Row not found in table!");
          return;
        }
    
        let rowNode = $(dataTableInstance.row(rowIndex).node());
        console.log(rowNode);
        let columns = Object.keys(row);

       
        rowNode.find('td').each(function (index) {
          let columnName = columns[index];
          let currentValue = $(this).text().trim();

          

          let inputElement;
          if (columnName === "Last Visit Date" || columnName === "Prior Auth Expiry Date") {
            // Date input field
            inputElement = `<input type="date" class="edit-input custom-date-input" value="${convertToISODate(currentValue)}">`;
          } else if (columnName === "Resident Full Name") {
            // Text input for Resident Full Name
            inputElement = `<input type="text" class="edit-input" value="${currentValue}">`;
            
            // Color dropdown selector with custom CSS class
            inputElement += `
                <select class="edit-input custom-drop small-color-picker">
                    <option value="" ${currentValue === "" ? "selected" : ""}>No Color</option>
                    <option value="#ffffff" ${currentValue === "#ffffff" ? "selected" : ""}>White</option>
                    <option value="#ff0000" ${currentValue === "#ff0000" ? "selected" : ""}>Red</option>
                    <option value="#d9d2e9" ${currentValue === "#d9d2e9" ? "selected" : ""}>Purple</option>
                </select>
            `;
        } else if (columnName === "BIMS score") {
            // Dropdown for BIMS Score
            inputElement = `<select class="edit-input custom-drop">${generateOptions([ "Select","0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "99", "Not Cognitive"], currentValue)}</select>`;
          }
          else if (columnName === "Biopsychosocial Assessment") {
            // Dropdown for BIMS Score
            inputElement = `<select class="edit-input custom-drop">${generateOptions([ "Select","Yes", "No"], currentValue)}</select>`;
          } else if (columnName === "Last Visit Type") {
            // Dropdown for Last Visit Type

            inputElement = `<select class="edit-input custom-drop">${generateOptions([
             "Select", "Biopsych Assessment", "CBT/ Psychotherapy", "Full Cognitive Exam", "Initial Med Visit",
              "Followup Med Visit", "Consult", "Pain Management", "SUD/Biopsychosocial assessment",
              "SUD/Med Visit", "SUD Intake", "SUD/CBT", "SUD Follow-up", "SUD Consult", "Initial Psych",
              "IOP Group Therapy", "IOP CBT", "PHP Group Therapy", "PHP CBT"
            ], currentValue)}</select>`;
          } else if (columnName === "Programs") {
            // Dropdown for Programs
            inputElement = `<select class="edit-input custom-drop">${generateOptions(["Select", "PRP-Completed", "IOP-Completed", "PHP-Completed", "PRP-Approved", "IOP-Approved", "PHP-Approved"], currentValue)}</select>`;
          } else if (columnName !== "Actions") {
            // Default text input
            inputElement = `<input type="text" class="edit-input" value="${currentValue}">`;
          }

          if (columnName !== "Actions") {
            $(this).html(inputElement);
          }
        });

        // Replace action buttons with "Save" and "Cancel"
        rowNode.find('td:last').html(`
        <div class="action-buttons">
            <button class="save-btn">Save</button>
            <button class="cancel-btn">Cancel</button>
        </div>
    `);
   
        // Handle "Save" click
        rowNode.find('.save-btn').off('click').on('click', function () {
    let updatedData = { id: id }; // Initialize with ID directly
    const sheetName = $('#sheetSelector').val();

    rowNode.find('td').each(function (index) {
        const columnName = columns[index];
        if (columnName === "Actions") return;

        let inputElement = $(this).find('input, select');
        let newValue = inputElement.val();

        // Handle date fields
        if (["Last Visit Date", "Prior Auth Expiry Date"].includes(columnName)) {
            updatedData[columnName] = newValue ? convertToUSDate(newValue) : row[columnName];
        } else {
            updatedData[columnName] = newValue || row[columnName];
        }

        // Handle background color for "Resident Full Name"
        if (columnName === "Resident Full Name") {
            const selectedColor = rowNode.find('select.small-color-picker').val();
            updatedData["Background"] = selectedColor;
            $(this).css('background-color', selectedColor);
        }
    });

    console.log("Updated Data:", updatedData);

    // Send updated data to Google Sheets
    $.ajax({
        url: "http://localhost:7002/editData",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: 'update',
            sheet_name: sheetName,
            newData: updatedData
        }),
        success: function (response) {
            if (response.success) {
                alert("Row updated successfully!");
                dataTableInstance.row(rowIndex).data(updatedData).draw(false);
                reloadtimeinterval = true;
            } else {
                reloadtimeinterval = true;
                alert("Failed to update row: " + response.message);
            }
        },
        error: function (jqXHR, textStatus, errorThrown) {
            reloadtimeinterval = true;
            alert(`Error: ${textStatus} - ${errorThrown}`);
        }
    });
});

// Handle "Cancel" click (Revert changes)
rowNode.find('.cancel-btn').off('click').on('click', function () {
    dataTableInstance.row(rowIndex).data(row).draw(false);
    reloadtimeinterval = true;
});
      }

      /// Utility function to convert MM/DD/YYYY to YYYY-MM-DD for <input type="date">
      function convertToISODate(dateString) {
        const parts = dateString.split('/');
        if (parts.length === 3) {
          const [month, day, year] = parts.map(Number);
          return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }
        return "";
      }

      // Utility function to convert YYYY-MM-DD back to MM/DD/YYYY for saving
      function convertToUSDate(isoDate) {
        if (!isoDate) return "";
        const parts = isoDate.split('-');
        if (parts.length === 3) {
          return `${parts[1]}/${parts[2]}/${parts[0]}`;
        }
        return isoDate;
      }

      // Utility function to generate <option> elements for dropdowns
      function generateOptions(optionsArray, selectedValue) {
        return optionsArray.map(option => `<option value="${option}" ${option === selectedValue ? "selected" : ""}>${option}</option>`).join('');
      }

      window.deleteRow = function (rowData) {
        const row = JSON.parse(decodeURIComponent(rowData));
        reloadtimeinterval = false;
        //console.log(reloadtimeinterval);
        console.log("Deleting Row:", row);
        let deleteconfirmation = true;
        let dischargeDate = prompt("Enter Discharge Date (MM/DD/YYYY) or leave blank to skip:");
        // Check if the user entered a discharge date
        if (dischargeDate !== null && dischargeDate.trim() !== "") { 
            if (!/^\d{2}\/\d{2}\/\d{4}$/.test(dischargeDate)) {
                alert("Invalid date format! Please use MM/DD/YYYY.");
                deleteConfirmation = false; 
                reloadtimeinterval = true;
            }
        }

       if(deleteconfirmation){
        if (!confirm("Are you sure you want to delete this row? This action cannot be undone.")) {
          deleteconfirmation = false;
          reloadtimeinterval = true;
        }
       }
        
        
        
       
        // Find the row index in DataTables
        let rowIndex = dataTableInstance.rows().indexes().filter(index => {
          return dataTableInstance.row(index).data()['id'] === row['id'];
        })[0];

        if (rowIndex === undefined) {
          console.error("Row not found in table!");
          deleteconfirmation = false;
          reloadtimeinterval = true;
  
        }
        console.log("fuction called sucesfully")


        console.log(row);

        if(deleteconfirmation){

          $.ajax({
       url: "http://localhost:7002/deleteData",
            method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({
        sheet_name: $('#sheetSelector').val(),
        rowData: row,
        dischargeDate: dischargeDate || ""
    }),
    success: async function (response) {
        console.log('Response:', response);
        if (response.success) {
            await alert("Row deleted successfully!");
            await fetchData();
            reloadtimeinterval = true;
        } else {
            alert("Failed to delete row: " + response.message);
            reloadtimeinterval = true;
        }
    },
    error: function (jqXHR, textStatus, errorThrown) {
        reloadtimeinterval = true;
        alert(`Error: ${textStatus} - ${errorThrown}`);
    }
});

        }
        
      };
    });

    // dataTableInstance.row(rowIndex).remove().draw(false); // Remove row from DataTable
    
    </script>
</body>

</html>